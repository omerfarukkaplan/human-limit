<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>HUMAN LIMIT</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.paddle.com/paddle/v2/paddle.js"></script>

<style>
body{
  margin:0;
  font-family:Inter,Arial;
  background:linear-gradient(135deg,#0f172a,#020617);
  color:white;
  text-align:center;
}
.container{max-width:1100px;margin:auto;padding:20px;}
.card{
  background:#111827;
  padding:25px;
  border-radius:15px;
  margin-bottom:20px;
  box-shadow:0 0 40px rgba(0,255,255,0.08);
}
button{
  padding:10px 15px;
  border:none;
  border-radius:8px;
  background:#22d3ee;
  font-weight:bold;
  cursor:pointer;
  margin:5px;
}
.hidden{display:none;}
.grid{
  display:grid;
  grid-template-columns:repeat(4,70px);
  gap:10px;
  justify-content:center;
}
.cell{
  width:70px;height:70px;background:#1f2937;
}
#gameArea{min-height:260px;}
</style>
</head>

<body>
<div class="container">

<h1>HUMAN LIMIT</h1>

<div class="card" id="authCard">
  <input id="emailInput" placeholder="Email"><br><br>
  <input id="passwordInput" type="password" placeholder="Password"><br><br>
  <button id="signupBtn">Sign Up</button>
  <button id="loginBtn">Login</button>
</div>

<div class="card hidden" id="dashboard">

<h2>Profile</h2>
<div id="profileBox"></div>
<button id="aiBtn">Generate AI Analysis</button>
<button id="shareBtn">Download Profile Card</button>

<h2>Referral</h2>
<div id="referralBox"></div>

<h2>Games</h2>
<div id="gameButtons"></div>
<div id="gameArea"></div>

<h2>Leaderboard</h2>
<div id="leaderboard"></div>

<h2>Premium</h2>
<button id="premiumBtn">Upgrade</button>

</div>

</div>

<script>
// ================== CONFIG ==================
const supabase = window.supabase.createClient(
  "https://mzvrzlwyvdfibusjfltf.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im16dnJ6bHd5dmRmaWJ1c2pmbHRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyMDYxODksImV4cCI6MjA4Njc4MjE4OX0.Y6c_KVS79tU1TL3ToZj5mfsXo5_UpzFk8rXZicEDFDo"
);

Paddle.Environment.set("sandbox");
Paddle.Initialize({token:"test_9d9daacf23a3e1f3ee848f1b8f0"});

// ================== AUTH ==================
const emailInput=document.getElementById("emailInput");
const passwordInput=document.getElementById("passwordInput");

document.getElementById("signupBtn").onclick=async()=>{
  await supabase.auth.signUp({
    email:emailInput.value,
    password:passwordInput.value
  });
  alert("Check email.");
};

document.getElementById("loginBtn").onclick=async()=>{
  const {error}=await supabase.auth.signInWithPassword({
    email:emailInput.value,
    password:passwordInput.value
  });
  if(!error) initApp();
};

// ================== INIT ==================
async function initApp(){
  document.getElementById("authCard").classList.add("hidden");
  document.getElementById("dashboard").classList.remove("hidden");
  loadProfile();
  loadLeaderboard();
  renderGames();
}

// ================== PROFILE ==================
async function loadProfile(){
  const {data:user}=await supabase.auth.getUser();

  const {data}=await supabase
    .from("users")
    .select("global_rank,percentile,badge,referral_code")
    .eq("id",user.user.id)
    .single();

  document.getElementById("profileBox").innerHTML=
  `Rank: ${data.global_rank || "-"} |
   Top ${data.percentile || "-"}% |
   Badge: ${data.badge || "Rookie"}`;

  document.getElementById("referralBox").innerHTML=
  `Your Code: ${data.referral_code}`;
}

// ================== AI ==================
document.getElementById("aiBtn").onclick=async()=>{
  const {data:user}=await supabase.auth.getUser();
  await fetch("https://mzvrzlwyvdfibusjfltf.supabase.co/functions/v1/generate-ai",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({user_id:user.user.id})
  });
  alert("AI Generated");
};

// ================== SHARE CARD ==================
document.getElementById("shareBtn").onclick=async()=>{
  const canvas=document.createElement("canvas");
  canvas.width=400;canvas.height=200;
  const ctx=canvas.getContext("2d");
  ctx.fillStyle="#0f172a";
  ctx.fillRect(0,0,400,200);
  ctx.fillStyle="#22d3ee";
  ctx.font="20px Arial";
  ctx.fillText("HUMAN LIMIT PROFILE",70,40);

  const {data:user}=await supabase.auth.getUser();
  const {data}=await supabase
    .from("users")
    .select("badge,percentile")
    .eq("id",user.user.id)
    .single();

  ctx.fillText("Badge: "+data.badge,100,100);
  ctx.fillText("Top "+data.percentile+"%",100,130);

  const link=document.createElement("a");
  link.download="profile.png";
  link.href=canvas.toDataURL();
  link.click();
};

// ================== SAVE SCORE ==================
async function saveScore(type,score){
  const {data:user}=await supabase.auth.getUser();
  await supabase.from("game_sessions").insert({
    user_id:user.user.id,
    game_type:type,
    score:score,
    raw_data:{}
  });
}

// ================== RATE LIMIT ==================
let lastGameTime=0;
function rateLimit(){
  if(Date.now()-lastGameTime<1000){
    alert("Slow down.");
    return false;
  }
  lastGameTime=Date.now();
  return true;
}

// ================== 20 GAMES ==================
const games={};

function renderGames(){
  const container=document.getElementById("gameButtons");
  container.innerHTML="";
  Object.keys(games).forEach(k=>{
    const b=document.createElement("button");
    b.innerText=k;
    b.onclick=()=>{ if(rateLimit()) games[k].start(); };
    container.appendChild(b);
  });
}

// 1 Reaction
games["Pro Reaction"]={
start:function(){
  const area=document.getElementById("gameArea");
  area.innerHTML="<canvas id='c' width='400' height='200'></canvas>";
  const c=document.getElementById("c");
  const ctx=c.getContext("2d");
  let clickable=false,start;
  ctx.fillStyle="red";ctx.fillRect(0,0,400,200);
  setTimeout(()=>{
    ctx.fillStyle="green";ctx.fillRect(0,0,400,200);
    start=performance.now();clickable=true;
  },Math.random()*2000+1000);

  c.onclick=()=>{
    if(!clickable)return;
    const r=performance.now()-start;
    if(r<120){alert("Invalid");return;}
    saveScore("reaction",Math.floor(r));
    alert("Reaction: "+Math.floor(r));
  };
}};

// 2 Memory Grid
games["Memory Grid"]={
start:function(){
  const area=document.getElementById("gameArea");
  area.innerHTML="<div class='grid' id='grid'></div>";
  const grid=document.getElementById("grid");
  let active=[];
  for(let i=0;i<16;i++){
    const cell=document.createElement("div");
    cell.className="cell";
    grid.appendChild(cell);
  }
  const cells=document.querySelectorAll(".cell");
  for(let i=0;i<4;i++){
    let r=Math.floor(Math.random()*16);
    active.push(r);
    cells[r].style.background="#22d3ee";
  }
  setTimeout(()=>cells.forEach(c=>c.style.background="#1f2937"),1000);
  let score=0;
  cells.forEach((c,i)=>{
    c.onclick=()=>{
      if(active.includes(i)){score++;c.style.background="#22d3ee";}
      if(score===4){saveScore("memory",score*25);alert("Success");}
    };
  });
}};

// 3â€“20 simplified scalable
for(let i=3;i<=20;i++){
  games["Game "+i]={
    start:function(){
      const area=document.getElementById("gameArea");
      const n=Math.floor(Math.random()*100);
      area.innerHTML=`<h3>Click if >50</h3><button id="g">${n}</button>`;
      document.getElementById("g").onclick=()=>{
        const score=n>50?100:0;
        saveScore("logic",score);
        alert("Score: "+score);
      };
    }
  };
}

// ================== LEADERBOARD ==================
async function loadLeaderboard(){
  const {data}=await supabase
    .from("leaderboard")
    .select("*")
    .order("iq_score",{ascending:false})
    .limit(10);
  const div=document.getElementById("leaderboard");
  div.innerHTML="";
  data.forEach(d=>div.innerHTML+=`<p>${d.iq_score}</p>`);
}

// ================== PREMIUM ==================
document.getElementById("premiumBtn").onclick=()=>{
  Paddle.Checkout.open({
    items:[{priceId:"pri_01khjtmydh0vjrmgc934n95339",quantity:1}]
  });
};
</script>

</body>
</html>