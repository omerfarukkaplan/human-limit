<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>HUMAN LIMIT</title>

<link rel="icon" type="image/svg+xml" href='data:image/svg+xml,
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
<rect width="100" height="100" fill="black"/>
<text x="50" y="65" font-size="60" fill="cyan" text-anchor="middle">H</text>
</svg>'>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.paddle.com/paddle/v2/paddle.js"></script>

<style>
body{
  margin:0;
  font-family:Inter,Arial;
  background:linear-gradient(135deg,#0f172a,#020617);
  color:white;
  text-align:center;
}
.container{max-width:1100px;margin:auto;padding:20px;}
.card{
  background:#111827;
  padding:25px;
  border-radius:15px;
  margin-bottom:20px;
  box-shadow:0 0 40px rgba(0,255,255,0.08);
}
button{
  padding:10px 15px;
  border:none;
  border-radius:8px;
  background:#22d3ee;
  font-weight:bold;
  cursor:pointer;
  margin:5px;
}
button.locked{
  background:#374151;
}
.hidden{display:none;}
.grid{
  display:grid;
  grid-template-columns:repeat(4,70px);
  gap:10px;
  justify-content:center;
}
.cell{
  width:70px;height:70px;background:#1f2937;
}
#gameArea{min-height:260px;}
</style>
</head>

<body>
<div class="container">

<h1>HUMAN LIMIT</h1>

<div class="card" id="authCard">
  <input id="emailInput" placeholder="Email"><br><br>
  <input id="passwordInput" type="password" placeholder="Password"><br><br>
  <button id="signupBtn">Sign Up</button>
  <button id="loginBtn">Login</button>
</div>

<div class="card hidden" id="dashboard">

<h2>Profile</h2>
<div id="profileBox"></div>
<button id="aiBtn">Generate AI Personality</button>
<button id="shareBtn">Download Profile Card</button>

<h2>Referral</h2>
<div id="referralBox"></div>

<h2>Games</h2>
<div id="gameButtons"></div>
<div id="gameArea"></div>

<h2>Leaderboard</h2>
<div id="leaderboard"></div>

<h2>Premium</h2>
<button id="premiumBtn">Upgrade</button>

</div>
</div>

<script>
// ===== SAFE SUPABASE INIT =====
if (!window.sb) {
  window.sb = window.supabase.createClient(
    "https://mzvrzlwyvdfibusjfltf.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im16dnJ6bHd5dmRmaWJ1c2pmbHRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyMDYxODksImV4cCI6MjA4Njc4MjE4OX0.Y6c_KVS79tU1TL3ToZj5mfsXo5_UpzFk8rXZicEDFDo"
  );
}
const supabase = window.sb;

// ===== PADDLE =====
Paddle.Environment.set("sandbox");
Paddle.Initialize({token:"test_9d9daacf23a3e1f3ee848f1b8f0"});

// ===== AUTH =====
const emailInput=document.getElementById("emailInput");
const passwordInput=document.getElementById("passwordInput");

document.getElementById("signupBtn").onclick=async()=>{
  await supabase.auth.signUp({
    email:emailInput.value,
    password:passwordInput.value
  });
  alert("Check email.");
};

document.getElementById("loginBtn").onclick=async()=>{
  const {error}=await supabase.auth.signInWithPassword({
    email:emailInput.value,
    password:passwordInput.value
  });
  if(!error) initApp();
};

// ===== INIT =====
let currentUser=null;
let isPremium=false;

async function initApp(){
  const {data:user}=await supabase.auth.getUser();
  currentUser=user.user;

  const {data:u}=await supabase
    .from("users")
    .select("is_premium,global_rank,percentile,badge,referral_code")
    .eq("id",currentUser.id)
    .single();

  isPremium=u.is_premium;

  document.getElementById("authCard").classList.add("hidden");
  document.getElementById("dashboard").classList.remove("hidden");

  document.getElementById("profileBox").innerHTML=
  `Rank: ${u.global_rank || "-"} |
   Top ${u.percentile || "-"}% |
   Badge: ${u.badge || "Rookie"}`;

  document.getElementById("referralBox").innerHTML=
  `Your Code: ${u.referral_code}`;

  renderGames();
  loadLeaderboard();
}

// ===== SAVE SCORE + AUTO IQ UPDATE =====
async function saveScore(type,score){

  await supabase.from("game_sessions").insert({
    user_id:currentUser.id,
    game_type:type,
    score:score,
    raw_data:{}
  });

  // IQ update edge
  await fetch("https://mzvrzlwyvdfibusjfltf.supabase.co/functions/v1/update-iq",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({user_id:currentUser.id})
  });

  // Rank update
  await fetch("https://mzvrzlwyvdfibusjfltf.supabase.co/functions/v1/update-rank",{
    method:"POST",
    headers:{"Content-Type":"application/json"}
  });

  loadLeaderboard();
}

// ===== 15 FREE + 5 PREMIUM =====
const games={};

function renderGames(){
  const container=document.getElementById("gameButtons");
  container.innerHTML="";
  Object.keys(games).forEach(k=>{
    const g=games[k];
    const b=document.createElement("button");
    b.innerText=k;

    if(g.premium && !isPremium){
      b.classList.add("locked");
      b.innerText=k+" ðŸ”’";
      b.onclick=()=>alert("Premium required");
    }else{
      b.onclick=()=>g.start();
    }
    container.appendChild(b);
  });
}

// ===== 10 REAL GAMES =====

// 1 Reaction
games["Reaction"]={
premium:false,
start:function(){
  const area=document.getElementById("gameArea");
  area.innerHTML="<div id='box' style='width:400px;height:200px;background:red;margin:auto'></div>";
  const box=document.getElementById("box");
  let start,clickable=false;
  setTimeout(()=>{
    box.style.background="green";
    start=performance.now();
    clickable=true;
  },Math.random()*2000+1000);
  box.onclick=()=>{
    if(!clickable)return;
    const r=Math.floor(performance.now()-start);
    alert("Reaction: "+r);
    saveScore("reaction",300-r);
  };
}};

// 2 Memory
games["Memory"]={
premium:false,
start:function(){
  const area=document.getElementById("gameArea");
  area.innerHTML="<div class='grid' id='grid'></div>";
  const grid=document.getElementById("grid");
  let active=[];
  for(let i=0;i<16;i++){
    const c=document.createElement("div");
    c.className="cell";
    grid.appendChild(c);
  }
  const cells=document.querySelectorAll(".cell");
  for(let i=0;i<4;i++){
    let r=Math.floor(Math.random()*16);
    active.push(r);
    cells[r].style.background="#22d3ee";
  }
  setTimeout(()=>cells.forEach(c=>c.style.background="#1f2937"),1000);
  let score=0;
  cells.forEach((c,i)=>{
    c.onclick=()=>{
      if(active.includes(i)){
        score++;
        c.style.background="#22d3ee";
      }
      if(score===4){
        alert("Success");
        saveScore("memory",100);
      }
    };
  });
}};

// 3â€“10 Logic Reflex
for(let i=3;i<=10;i++){
  games["Logic "+i]={
    premium:false,
    start:function(){
      const n=Math.floor(Math.random()*100);
      const area=document.getElementById("gameArea");
      area.innerHTML=`<h3>${n}</h3><button id='b'>Is > 50?</button>`;
      document.getElementById("b").onclick=()=>{
        const score=n>50?100:0;
        saveScore("logic",score);
        alert("Score: "+score);
      };
    }
  };
}

// ===== 5 PREMIUM GAMES =====
for(let i=1;i<=5;i++){
  games["Pro Game "+i]={
    premium:true,
    start:function(){
      const n=Math.floor(Math.random()*200);
      const area=document.getElementById("gameArea");
      area.innerHTML=`<h3>Double Reflex: ${n}</h3>
      <button id='b'>Fast?</button>`;
      document.getElementById("b").onclick=()=>{
        const score=n>100?150:50;
        saveScore("pro",score);
        alert("Score: "+score);
      };
    }
  };
}

// ===== AI =====
document.getElementById("aiBtn").onclick=async()=>{
  await fetch("https://mzvrzlwyvdfibusjfltf.supabase.co/functions/v1/generate-ai",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({user_id:currentUser.id})
  });
  alert("AI Profile Generated");
};

// ===== LEADERBOARD =====
async function loadLeaderboard(){
  const {data}=await supabase
    .from("leaderboard")
    .select("*")
    .order("iq_score",{ascending:false})
    .limit(10);

  const div=document.getElementById("leaderboard");
  div.innerHTML="";
  data.forEach(d=>{
    div.innerHTML+=`<p>${d.iq_score}</p>`;
  });
}

// ===== PREMIUM CHECKOUT =====
document.getElementById("premiumBtn").onclick=()=>{
  Paddle.Checkout.open({
    items:[{priceId:"pri_01khjtmydh0vjrmgc934n95339",quantity:1}]
  });
};
</script>

</body>
</html>