<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>HUMAN LIMIT - Survivor Mode</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
    margin:0;
    background:#0f0f14;
    color:white;
    font-family:Arial, sans-serif;
    text-align:center;
}

.container {
    margin-top:80px;
}

.ms {
    font-size:80px;
    font-weight:bold;
    margin:20px 0;
}

.button {
    padding:15px 30px;
    background:#00ff99;
    border:none;
    border-radius:8px;
    cursor:pointer;
    font-size:18px;
    margin-top:20px;
}

.leaderboard {
    margin-top:50px;
    max-width:400px;
    margin-left:auto;
    margin-right:auto;
    text-align:left;
}

.card {
    padding:10px;
    border-bottom:1px solid #222;
}

.red { color:#ff4d4d; }
.green { color:#00ff99; }
</style>
</head>

<body>

<div class="container">
    <h1>HUMAN LIMIT - Survivor Mode</h1>

    <div id="status"></div>
    <div class="ms" id="result">TAP TO BEGIN</div>
    <button class="button" onclick="startGame()">START</button>

    <div class="leaderboard">
        <h3>ðŸ”¥ Top Survivors</h3>
        <div id="board"></div>
    </div>
</div>

<script>

// =============================
// SUPABASE CONFIG
// =============================

const SUPABASE_URL = "https://YOUR_PROJECT_ID.supabase.co";
const SUPABASE_KEY = "YOUR_PUBLIC_ANON_KEY";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// =============================
// GLOBALS
// =============================

let startTime;
let hasPlayedToday = false;
let activeSeasonId = null;
let nickname = null;

// =============================
// INIT
// =============================

init();

async function init() {

    nickname = localStorage.getItem("nickname");

    if(!nickname){
        nickname = prompt("Nickname gir:");
        localStorage.setItem("nickname", nickname);
    }

    await loadActiveSeason();
    await checkDailyPlay();
    await loadLeaderboard();
}

// =============================
// LOAD ACTIVE SEASON
// =============================

async function loadActiveSeason() {

    const { data } = await supabase
        .from("seasons")
        .select("*")
        .eq("is_active", true)
        .limit(1)
        .single();

    if(data){
        activeSeasonId = data.id;
    }
}

// =============================
// CHECK DAILY PLAY
// =============================

async function checkDailyPlay(){

    const today = new Date().toISOString().split("T")[0];

    const { data } = await supabase
        .from("daily_scores")
        .select("*")
        .eq("nickname", nickname)
        .eq("season_id", activeSeasonId)
        .gte("created_at", today);

    if(data.length > 0){
        hasPlayedToday = true;
        document.getElementById("status").innerHTML =
            "<div class='red'>Eliminated today!</div>";
    }
}

// =============================
// GAME LOGIC
// =============================

function startGame(){

    if(hasPlayedToday){
        alert("BugÃ¼n oynadÄ±n. YarÄ±n tekrar dene.");
        return;
    }

    document.getElementById("result").innerHTML = "WAIT...";
    startTime = Date.now();

    setTimeout(() => {
        document.body.onclick = registerClick;
    }, Math.random()*2000 + 1000);
}

async function registerClick(){

    const reaction = Date.now() - startTime;
    document.body.onclick = null;

    document.getElementById("result").innerHTML = reaction + " ms";

    await saveScore(reaction);

    hasPlayedToday = true;
    document.getElementById("status").innerHTML =
        "<div class='red'>Eliminated today!</div>";

    await loadLeaderboard();
}

// =============================
// SAVE SCORE
// =============================

async function saveScore(reaction){

    await supabase.from("scores").insert({
        nickname: nickname,
        reaction: reaction,
        season_id: activeSeasonId,
        client_hash: generateHash()
    });

    await supabase.from("daily_scores").insert({
        nickname: nickname,
        reaction: reaction,
        season_id: activeSeasonId,
        client_hash: generateHash()
    });
}

// =============================
// LOAD LEADERBOARD
// =============================

async function loadLeaderboard(){

    const { data } = await supabase
        .from("scores")
        .select("*")
        .eq("season_id", activeSeasonId)
        .order("reaction", { ascending: true })
        .limit(10);

    const board = document.getElementById("board");
    board.innerHTML = "";

    data.forEach((row, index) => {

        const div = document.createElement("div");
        div.className = "card";

        div.innerHTML =
            (index+1) + ". " +
            row.nickname +
            " - " +
            row.reaction + " ms";

        board.appendChild(div);
    });
}

// =============================
// HASH
// =============================

function generateHash(){
    return btoa(navigator.userAgent + Date.now());
}

</script>

</body>
</html>