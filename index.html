<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Human Limit</title>
<script src="https://cdn.paddle.com/paddle/v2/paddle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body { font-family: Arial; text-align:center; background:#111; color:#fff; }
button { padding:12px 20px; margin:10px; font-size:16px; }
.card { margin-top:20px; }
</style>
</head>
<body>

<h1>HUMAN LIMIT</h1>

<div id="auth">
  <input id="email" placeholder="Email" />
  <button onclick="createUser()">Start</button>
</div>

<div id="game" style="display:none;">
  <h2>Reaction Test</h2>
  <button id="reactionBtn" onclick="reactionClick()" disabled>WAIT...</button>

  <h2>Tap Speed (5 sec)</h2>
  <button onclick="startTap()">START TAP</button>
  <div id="tapCount"></div>

  <button onclick="finishGame()">Finish & Calculate</button>
</div>

<div id="result" style="display:none;" class="card">
  <h2>Your Profile</h2>
  <div id="score"></div>
  <button onclick="buyCoins()">Buy 100 Coins</button>
</div>

<script>
const supabase = window.supabase.createClient(
  "https://mzvrzlwyvdfibusjfltf.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im16dnJ6bHd5dmRmaWJ1c2pmbHRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyMDYxODksImV4cCI6MjA4Njc4MjE4OX0.Y6c_KVS79tU1TL3ToZj5mfsXo5_UpzFk8rXZicEDFDo"
);

let userId = null;
let reactionStart = 0;
let reactionTime = 0;
let tapCount = 0;

function createUser() {
  const email = document.getElementById("email").value;
  supabase.from("users").insert({ email })
    .select()
    .then(res => {
      userId = res.data[0].id;
      document.getElementById("auth").style.display="none";
      document.getElementById("game").style.display="block";
      startReaction();
    });
}

function startReaction() {
  const btn = document.getElementById("reactionBtn");
  setTimeout(()=>{
    btn.innerText="CLICK!";
    btn.disabled=false;
    reactionStart = Date.now();
  }, Math.random()*3000 + 1000);
}

function reactionClick() {
  reactionTime = Date.now() - reactionStart;
  document.getElementById("reactionBtn").innerText="Done";
  document.getElementById("reactionBtn").disabled=true;
}

function startTap() {
  tapCount = 0;
  document.getElementById("tapCount").innerText="0";
  const interval = setInterval(()=>{
    tapCount++;
    document.getElementById("tapCount").innerText=tapCount;
  },100);

  setTimeout(()=>{
    clearInterval(interval);
  },5000);
}

async function finishGame() {

  const session = {
    reaction_time: reactionTime,
    early_click_rate: 0,
    tap_count: tapCount,
    risk_choice: "risk"
  };

  await supabase.from("game_sessions").insert({
    user_id: userId,
    reaction_time: reactionTime,
    tap_count: tapCount,
    risk_choice: "risk"
  });

  const response = await fetch(
    "https://mzvrzlwyvdfibusjfltf.supabase.co/functions/v1/calculate-profile",
    {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ user_id: userId, session })
    }
  );

  const data = await response.json();

  document.getElementById("game").style.display="none";
  document.getElementById("result").style.display="block";
  document.getElementById("score").innerHTML=
    "Human Index: "+Math.round(data.human_index)+"<br>Tier: "+data.tier;
}

Paddle.Environment.set("production");
Paddle.Initialize({
  token: "test_9d9daacf23a3e1f3ee848f1b8f0"
});

function buyCoins(){
  Paddle.Checkout.open({
    items: [{
      priceId: "pri_01khjtmydh0vjrmgc934n95339",
      quantity: 1
    }],
    customData: {
      email: document.getElementById("email").value
    }
  });
}
</script>

</body>
</html>